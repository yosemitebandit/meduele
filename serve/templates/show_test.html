{% extends "layout.html" %}

{% block head %}
<script type="text/javascript"
  src="http://static.twilio.com/libs/twiliojs/1.0/twilio.min.js"></script>
<script type="text/javascript"
  src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js">
</script>
<link href="/static/twilio.css" type="text/css" rel="stylesheet" />
<script type="text/javascript">
  var js_token = "{{ token }}";
  try {
    Twilio.Device.setup(js_token);
  } catch (err) {
    console.log("Adobe Flash is required to use Twilio Client.");
  }
  
  Twilio.Device.ready(function (device) {
    $("#log").text("Ready");
  });

  Twilio.Device.error(function (error) {
    $("#log").text("Error: " + error.message);
  });

  Twilio.Device.connect(function (conn) {
    $("#log").text("Successfully established call");
  });

  Twilio.Device.disconnect(function (conn) {
    $("#log").text("Call ended");
  });

  Twilio.Device.incoming(function (conn) {
    $("#log").text("Incoming connection from " + conn.parameters.From);
    // accept the incoming connection and start two-way audio
    conn.accept();
  });
  
  Twilio.Device.presence(function (pres) {
    if (pres.available) {
      // create an item for the client that became available
      $("<li>", {id: pres.from, text: pres.from}).click(function () {
        $("#number").val(pres.from);
        call();
      }).prependTo("#people");
    }
    else {
      // find the item by client name and remove it
      $("#" + pres.from).remove();
    }
  });
  
  function call() {
    // get the phone number to connect the call to
    params = {"PhoneNumber": $("#number").val()};
    Twilio.Device.connect(params);
    $("#call_button").text("Hang up");
    $("#call_button").attr('onclick', '').click(function() { hangup(); });
  }

  function hangup() {
    Twilio.Device.disconnectAll();
    $("#call_button").text("Call");
    $("#call_button").attr('onclick', '').click(function() { call(); });
  }
</script>
{% endblock %}

{% block body %}
    <div class="row">
      <div class="span10">
        <button id="call_button" onclick="call();">
          Call
        </button>
        <h1>Your name is <b>{{ client }}</b></h1>
        <p>Your token is <b>{{ token }}</b></p>
        <input type="text" id="number" name="number"
          placeholder="Enter a phone number to call"/>

        <div id="log">Loading pigeons...</div>

        <ul id="people"/>
      </div>
    </div>
{% endblock %}